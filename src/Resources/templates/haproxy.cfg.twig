global

defaults
    mode {{ config.default.mode }}
    timeout connect {{ config.defaults.timeout_connect }}
    timeout client {{ config.defaults.timeout_client }}
    timeout server {{ config.defaults.timeout_server }}


frontend http
    bind       {{ config.frontend.bind }}
    mode       {{ config.frontend.mode }}

{% for service in services %}{% for host in service.hosts %}
    acl host_{{ service.name }}{{ service.id }} hdr_end(host) -i {{ host }}
{% endfor %}{% endfor %}

{% for service in services %}
    use backend backend_{{ service.id}} if host_{{ service.id }}
{% endfor %}

{% for service in services %}

backend backend_{{ service.id }}
    mode http
    balance roundrobin
    option forwardfor
    http-request set-header X-Forwarded-Port %[dst_port]
    server web_{{ service.id}} {{ service.ip }}:{{ service.port }} check

{% endfor %}